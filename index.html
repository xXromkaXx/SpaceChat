<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpaceChat - –ú—ñ–∂–ø–ª–∞–Ω–µ—Ç–Ω–∏–π —á–∞—Ç</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>

    </style>
</head>
<body>
<div class="stars"></div>
<div class="stars2"></div>
<div class="stars3"></div>
<div class="comet"></div>

<div class="container">
    <header>
        <div class="header-content">
            <div class="logo">
                <h1>SpaceChat</h1>
            </div>
            <div class="user-panel" id="userPanel">
                <div class="user-avatar">
                    <i class="fas fa-user-astronaut"></i>
                </div>
                <div id="userInfo">
                    <div>–ì—ñ—Å—Ç—å</div>
                    <div class="contact-status">–ù–µ –≤ –º–µ—Ä–µ–∂—ñ</div>
                </div>
            </div>
        </div>
    </header>

    <div class="login-section" id="loginSection">
        <h2>–í—Ö—ñ–¥ –¥–æ –∫–æ—Å–º—ñ—á–Ω–æ–≥–æ —á–∞—Ç—É</h2>
        <input type="text" id="usernameInput" class="login-input" placeholder="–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è">
        <button id="loginBtn" class="login-btn">–£–≤—ñ–π—Ç–∏ –¥–æ —á–∞—Ç—É</button>
    </div>

    <!-- Overlay –¥–ª—è –º–æ–±—ñ–ª—å–Ω–æ–≥–æ -->
    <div class="users-overlay" id="usersOverlay">
        <div class="overlay-content">
            <div class="overlay-header">
                <h3>–ö–æ—Å–º–æ–Ω–∞–≤—Ç–∏ –æ–Ω–ª–∞–π–Ω</h3>
                <button id="closeUsers" class="close-users-btn">‚úï</button>
            </div>
            <ul class="user-list" id="mobileUserList"></ul>
        </div>
    </div>
        <button id="toggleUsers" class="toggle-users-btn">üë®‚ÄçüöÄ –û–Ω–ª–∞–π–Ω</button>

        <div class="chat-main">
            <div class="chat-header">
                <div class="chat-title">–ó–∞–≥–∞–ª—å–Ω–∏–π –∫–æ—Å–º—ñ—á–Ω–∏–π —á–∞—Ç</div>
                <div class="user-count"><span id="onlineCount">1</span> –∫–æ—Å–º–æ–Ω–∞–≤—Ç(—ñ–≤) –æ–Ω–ª–∞–π–Ω</div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message received">
                    <div class="message-content">
                        <div class="message-sender">–¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è</div>
                        <div>–õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –∫–æ—Å–º—ñ—á–Ω–æ–≥–æ —á–∞—Ç—É! –¢—É—Ç –≤–∏ –º–æ–∂–µ—Ç–µ —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è –∑ —ñ–Ω—à–∏–º–∏ –∫–æ—Å–º–æ–Ω–∞–≤—Ç–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ.</div>
                        <div class="message-time">10:00</div>
                    </div>
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="messageInput" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...">
                <button id="sendMessage"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <footer>
        <p>¬© 2023 SpaceChat. –ö–æ—Å–º—ñ—á–Ω–∏–π —á–∞—Ç –¥–ª—è —Å–ø—Ä–∞–≤–∂–Ω—ñ—Ö –∞—Å—Ç—Ä–æ–Ω–∞–≤—Ç—ñ–≤</p>
    </footer>

    <div class="connection-status" id="connectionStatus">
        <div class="status-indicator status-disconnected"></div>
        <span>–í—ñ–¥–∫–ª—é—á–µ–Ω–æ</span>
    </div>
</div>

<script>
    // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è Firebase (–∑–∞–º—ñ–Ω—ñ—Ç—å –Ω–∞ —Å–≤–æ—é)
    const firebaseConfig = {
        apiKey: "AIzaSyD7VL448wuUgDLU1F5vnmN-bc1CC0r3vgM",
        authDomain: "spacechat-624bf.firebaseapp.com",
        projectId: "spacechat-624bf",
        storageBucket: "spacechat-624bf.firebasestorage.app",
        messagingSenderId: "309487888962",
        appId: "1:309487888962:web:e61a9dcfdd03bb42e59bdb",
        measurementId: "G-4H78V9FXKM"
    };


    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener('DOMContentLoaded', function() {
        const loginSection = document.getElementById('loginSection');
        const chatContainer = document.getElementById('chatContainer');
        const usernameInput = document.getElementById('usernameInput');
        const loginBtn = document.getElementById('loginBtn');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendMessage');
        const chatMessages = document.getElementById('chatMessages');
        const userList = document.getElementById('userList');
        const onlineCount = document.getElementById('onlineCount');
        const userInfo = document.getElementById('userInfo');
        const connectionStatus = document.getElementById('connectionStatus');

        let username = '';
        let users = [];
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
        function updateConnectionStatus(connected) {
            const indicator = connectionStatus.querySelector('.status-indicator');
            const text = connectionStatus.querySelector('span');

            if (connected) {
                indicator.className = 'status-indicator status-connected';
                text.textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                text.textContent = '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ';
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function addMessage(sender, text, isCurrentUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isCurrentUser ? 'sent' : 'received'}`;

            const now = new Date();
            const timeString = `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;

            messageDiv.innerHTML = `
                    <div class="message-content">
                        ${!isCurrentUser ? `<div class="message-sender">${sender}</div>` : ''}
                        <div>${text}</div>
                        <div class="message-time">${timeString}</div>
                    </div>
                `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                // –î–æ–¥–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Firestore
                db.collection('messages').add({
                    sender: username,
                    text: message,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: ', error);
                });

                messageInput.value = '';
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function updateUserList(usersArray) {
            userList.innerHTML = '';

            usersArray.forEach(user => {
                const userItem = document.createElement('li');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                        <div class="user-avatar-sm">
                            <i class="fas fa-user-astronaut"></i>
                        </div>
                        <div>${user}</div>
                        <div class="online-indicator"></div>
                    `;
                userList.appendChild(userItem);
            });

            onlineCount.textContent = usersArray.length;
        }

        // –ü—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω —É –∫–æ–ª–µ–∫—Ü—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        function setupMessagesListener() {
            unsubscribeMessages = db.collection('messages')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            addMessage(data.sender, data.text, data.sender === username);
                        }
                    });
                }, error => {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å: ', error);
                });
        }

        // –ü—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞–Ω–Ω—è –∑–º—ñ–Ω —É –∫–æ–ª–µ–∫—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
        function setupUsersListener() {
            unsubscribeUsers = db.collection('users')
                .onSnapshot(snapshot => {
                    const usersArray = [];
                    snapshot.forEach(doc => {
                        usersArray.push(doc.id);
                    });
                    updateUserList(usersArray);
                }, error => {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–ø–∏—Å–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: ', error);
                });
        }

        // –û–±—Ä–æ–±–∫–∞ –≤—Ö–æ–¥—É –≤ —á–∞—Ç
        loginBtn.addEventListener('click', function() {
            username = usernameInput.value.trim();
            if (username) {
                // –î–æ–¥–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ Firestore
                db.collection('users').doc(username).set({
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    loginSection.style.display = 'none';
                    chatContainer.style.display = 'flex';
                    userInfo.querySelector('div').textContent = username;
                    userInfo.querySelector('.contact-status').textContent = '–í –º–µ—Ä–µ–∂—ñ';

                    // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –ø—Ä–æ—Å–ª—É—Ö–æ–≤—É–≤–∞—á—ñ
                    setupMessagesListener();
                    setupUsersListener();

                    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç—É—Å –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
                    updateConnectionStatus(true);

                    // –î–æ–¥–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
                    db.collection('messages').add({
                        sender: '–°–∏—Å—Ç–µ–º–∞',
                        text: `${username} –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è –¥–æ —á–∞—Ç—É`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }).catch(error => {
                    console.error('–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: ', error);
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É –≤ —á–∞—Ç. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–µ —ñ–º\'—è.');
                });
            }
        });

        // –û–±—Ä–æ–±–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∞—Å—É –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        function updateUserActivity() {
            if (username) {
                db.collection('users').doc(username).update({
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
        setInterval(updateUserActivity, 30000);

        // –í–∏–¥–∞–ª—è—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        window.addEventListener('beforeunload', function() {
            if (username) {
                // –í—ñ–¥–ø–∏—Å—É—î–º–æ—Å—è –≤—ñ–¥ —Å–ª—É—Ö–∞—á—ñ–≤
                if (unsubscribeMessages) unsubscribeMessages();
                if (unsubscribeUsers) unsubscribeUsers();

                // –í–∏–¥–∞–ª—è—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
                db.collection('users').doc(username).delete();

                // –î–æ–¥–∞—î–º–æ —Å–∏—Å—Ç–µ–º–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
                db.collection('messages').add({
                    sender: '–°–∏—Å—Ç–µ–º–∞',
                    text: `${username} –ø–æ–∫–∏–Ω—É–≤ —á–∞—Ç`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Firebase
        firebase.firestore().enableNetwork()
            .then(() => {
                console.log("–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ Firebase");
            })
            .catch((error) => {
                console.error("–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: ", error);
                updateConnectionStatus(false);
            });
    });

    const toggleUsersBtn = document.getElementById('toggleUsers');
    const usersOverlay = document.getElementById('usersOverlay');
    const closeUsersBtn = document.getElementById('closeUsers');
    const userList = document.getElementById('userList');           // –¥–µ—Å–∫—Ç–æ–ø
    const mobileUserList = document.getElementById('mobileUserList');
    // –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è —Å–ø–∏—Å–∫—É
    toggleUsersBtn.addEventListener('click', () => {
        usersOverlay.classList.add('active');
        document.body.style.overflow = "hidden";
    });

    // –∑–∞–∫—Ä–∏—Ç—Ç—è —Å–ø–∏—Å–∫—É
    closeUsersBtn.addEventListener('click', () => {
        usersOverlay.classList.remove('active');
        document.body.style.overflow = "";
    });

    // –∫–æ–ª–∏ –æ–Ω–æ–≤–ª—é—î—à —é–∑–µ—Ä—ñ–≤, –æ–Ω–æ–≤–ª—é–π –æ–±–∏–¥–≤–∞ —Å–ø–∏—Å–∫–∏
    function updateUserList(usersArray) {
        userList.innerHTML = '';
        mobileUserList.innerHTML = '';

        usersArray.forEach(user => {
            const li = `
      <li class="user-item">
        <div class="user-avatar-sm"><i class="fas fa-user-astronaut"></i></div>
        <div>${user}</div>
        <div class="online-indicator"></div>
      </li>`;
            userList.insertAdjacentHTML('beforeend', li);
            mobileUserList.insertAdjacentHTML('beforeend', li);
        });

        onlineCount.textContent = usersArray.length;
    }

</script>
</body>
</html>